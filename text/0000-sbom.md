# Meta
[meta]: #meta
- Name: Structured SBOMs
- Start Date: 2021-06-02
- Author(s): [@samj1912](https://github.com/samj1912), [@sophiewigmore](https://github.com/sophiewigmore), [@ForestEckhardt](https://github.com/ForestEckhardt)
- RFC Pull Request: (leave blank)
- CNB Pull Request: (leave blank)
- CNB Issue: (leave blank)
- Supersedes: (put "N/A" unless this replaces an existing RFC, then link to that RFC)

# Summary
[summary]: #summary

This RFC proposes the following - 

- Use of CycloneDX as the SBOM storage format.
- Moving the SBOM from `<layer>.toml`, `launch.toml` and `build.toml` to separate files.

# Definitions
[definitions]: #definitions

- SBOM/BOM: A software bill of materials (SBOM) is a list of components in a piece of software. Software vendors often create products by assembling open source and commercial software components. The SBOM describes the components in a product. In case of buildpacks the SBOM describes the contents of the various layers, buildpacks, stacks and the output app container.
- CycloneDX: CycloneDX is a lightweight software bill of materials (SBOM) standard designed for use in application security contexts and supply chain component analysis.
- SPDX: Software Package Data Exchange (SPDX) is a file format used to document information on the software licenses under which a given piece of computer software is distributed.
- SWID: SWID is a formal industry standard used by various commercial software publishers designed with software inventory and entitlements management in mind.

# Motivation
[motivation]: #motivation

## Why should we do this?

Quoting [NTIA Whitepaper][NTIA-WP] - 
> Modern software systems involve increasingly complex and dynamic supply chains. Unfortunately, the composition and functionality of these systems lacks transparency; this contributes substantially to cybersecurity risks, alongside the cost of development, procurement, and maintenance. This has broad implications in our interconnected world; risk and cost affect collective goods, like public safety and national security, in addition to the products and services upon which businesses rely.
> We propose that increased supply chain transparency through SBOMs can reduce cybersecurity risks and overall costs by:
> - Enhancing the identification of vulnerable systems and the root cause of incidents
> - Reducing unplanned and unproductive work
> - Supporting more informed market differentiation and component selection
> - Reducing duplication of effort by standardizing formats across multiple sectors
> - Identifying suspicious or counterfeit software components

Currently since container images built by Cloud Native Buildpacks don't follow a generic file system layout, they may not be easily scannable by container scanning tools. We do however provide a BOM which should greatly help sidestep the entire manual scanning process and speed up things like CVE detection by directly providing the CVE scanner with a BOM.

However, since we currently do not impose any standard for what the BOM should look like and since the metadata table in BOM is a freeform table, it is very hard to have consistent BOMs that can be used by CVE scanners.

Having a structured and consistent SBOM that can be consumed by downstream systems could greatly enhance the security proposition around buildpacks.

## What use cases does it support?

- Consistent SBOM across buildpacks
- Improved integration with other supply chain analysis and scanning tools

## What is the expected outcome?

- Use of CycloneDX as the SBOM storage format and updates the the specification and lifecycle to reflect the same.
- Moving the SBOM from `<layer>.toml`, `launch.toml` and `build.toml` to separate files.

# What it is
[what-it-is]: #what-it-is

Currently the SBOM is defined in the `<layer>.toml`, `launch.toml` and `build.toml` respectively under the `[bom]` table.
It may not be the most user-friendly way for buildpack authors to create SBOM documents in the above format. This RFC proposes that the `bom` be moved to `<layer>.bom.<ext>`, `launch.bom.<ext>` and `build.bom.<ext>` instead where `<ext>` will be `cdx.json`

The above bom documents need to be created in CycloneDX format.

The lifecycle of the respective `bom` files during rebuilds would be exactly the same as the `bom` table currently. 

The lifecycle would be responsible for taking all of the above `bom` files, merging it while tagging it with the originating layer or buildpack the `bom` came from and storing it in `/layers/config/build.bom.cdx.json` and `/layers/config/launch.bom.cdx.json` respectively for `build` and `launch` boms.

# How it Works
[how-it-works]: #how-it-works

The lifecycle would be responsible for reading, merging and restoring the appropriate `bom` files. The lifecycle of these `bom` files would be tied to their respectice metadata `toml` files. See [RFC 0087](https://github.com/buildpacks/rfcs/blob/main/text/0087-bom-in-layer-metadata.md#how-it-works) for more details. For merging the `bom` files, the lifecycle could replicate or use tooling from [CycloneDX-cli](https://github.com/CycloneDX/cyclonedx-cli) which has a merge operation. The only additional piece of information that the lifecycle would inject are `CycloneDX` [`metadata`](https://cyclonedx.org/use-cases/#properties--name-value-store) the following property keys -

- `io.buildpacks.bom.buildpack.id` - Buildpack ID for the buildpack that created the BOM
- `io.buildpacks.bom.layer.name` (Optional) - Set to the name of the layer if the `bom` was associated with a specific layer. 

Thw lifecycle will put all the `build` related entries in the `/layers/config/build.bom.cdx.json` file and `launch` entries in `/layers/config/launch.bom.cdx.json`

# Backwards compatibility

For `BOM` from older buildpacks the following mappings will be defined. Each `BOM` entry will be added as a `CycloneDX` component in the final components list.

For eg. if we have the BOM table like below -

```toml
[[bom]]
name = "example"
[bom.metadata]
version = "0.2.3"
foo = "bar"
foo_array = ["bar"]
[[bom]]
name = "example2"
[bom.metadata]
version = "0.0.1"
foo = "bar"
```

It will be converted to - 

```json
{
  "bomFormat": "CycloneDX",
  "specVersion": "1.3",
  "serialNumber": "urn:uuid:3e671687-395b-41f5-a30f-a58921a69b79",
  "version": 1,
  "components": [
    {
      "type": "library",
      "name": "example",
      "version": "0.2.3",
      "metadata": {
          "foo": "bar",
          "foo_array": ["bar"]
      }
    },
    {
      "type": "library",
      "name": "example2",
      "version": "0.0.1",
      "metadata": {
          "foo": "bar",
      }
    },
  ]
}
```

Since `CycloneDX v1.3` does not define a `metadata` key inside the `component` type, we can simply put the existing `metadata` table inside the `metadata` key in a `component` and use the `loose` JSON schema for `CycloneDX 1.3`.

The `version` key inside the `metadata` table will be handled as a unique case and will be moved to a top level `version` key inside the `CycloneDX` component.

# Drawbacks
[drawbacks]: #drawbacks

This RFC adds a fair bit of complexity to the lifecycle and makes it responsible for more than just buildpack orchestration and container/layer assembly.

# Alternatives
[alternatives]: #alternatives

## Use a different SBOM format (SPDX)

SPDX is the other leading SBOM format. It is a Linux Foundation project and is another front-runner in the SBOM eco-system. SPDX is heavily focused on compliance related metadata whereas CycloneDX is focused on security and supply chain analysis. SPDX also doesn't have as rich of an ecosystem when it comes to tooling for generating SBOMs as CycloneDX.

For reference see - https://cyclonedx.org/tool-center/

A more complete analysis of leading SPDX and CycloneDX tooling relevant to Buildpacks is documented at [sophiewigmore/bom](https://github.com/sophiewigmore/bom). This includes common SBOM field mapping, example SBOM outputs, scanning times.

## Delegate SBOM merging to platform

The main reason that the lifecycle needs to have a hard dependency on CycloneDX in this proposal is because we propose that the lifecycle merges the SBOM from various buildpacks and layers. If the lifecycle were to not do this, the content of the SBOM can be completely opaque to the lifecycle. This might provide greater flexibility and almost no dependency on the lifecycle side. Instead a platform like `pack` can be responsible for gathering the individual SBOM files and merging them together for the user. This can also be provided as a reusable library/CLI so that other platforms could do the same.


# Prior Art
[prior-art]: #prior-art

- [#RFC 53](https://github.com/buildpacks/rfcs/blob/main/text/0053-decouple-buildpack-plan-and-bom.md)
- [#RFC 87](https://github.com/buildpacks/rfcs/blob/main/text/0087-bom-in-layer-metadata.md)

# Unresolved Questions
[unresolved-questions]: #unresolved-questions

- Implementation details about how the lifecycle should be merging the SBOMs.
- Moving the SBOM from the `io.buildpacks.build.metadata` label to a file in the output image to avoid large labels
- Interactions with the stack SBOM and how to represent that and merge it with the Buildpack SBOM.

# Spec. Changes (OPTIONAL)
[spec-changes]: #spec-changes

Yes, see above.

# References

The above RFC was inspired by [NTIA SBOM Formats and Standards Whitepaper - VERSION 202104XX][NTIA-WP] and borrows heavily from it for definitions and references.


[NTIA-WP]: https://docs.google.com/document/d/1KEMRrjbMd6FV7-ZFCk-AVVi-QY7qRiYiylxFFUc5Y_8/edit#
[CDX]: https://cyclonedx.org/
[SPDX]: https://spdx.dev/
[SWID]: https://nvd.nist.gov/products/swid